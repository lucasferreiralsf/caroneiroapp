kind: pipeline
type: docker
name: default

platform:
  os: linux
  arch: amd64

# server:
#   host: caroneiroapp.com.br
#   user: root
#   password:
#     from_secret: password
# workspace:
#   base: /go
#   path: src/github.com/caroneiroapp/app

steps:
# - name: backend
#   image: docker/compose
#   volumes:
#   - name: docker_sock
#     path: /var/run/docker.sock
#   commands:
#     - docker-compose -f docker-compose-prod.yml up --force-recreate -d caroneiro_api

- name: build
  image: docker:dind
  commands:
    - docker build -f /caroneiro-api/Dockerfile-production -t lucasferreira/caroneiroapi:latest
  volumes:
    # - name: docker_sock
    #   path: /var/run/docker.sock
    - name: dockersock
      path: /var/run

- name: deploy
  image: docker:dind
  volumes:
    # - name: docker_sock
    #   path: /var/run/docker.sock
    - name: dockersock
      path: /var/run
  commands:
    - docker run lucasferreira/caroneiroapi:latest --name caroneiro_api

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run

volumes:
  - name: docker_sock
    host:
      path: /var/run/docker.sock
  - name: dockersock
    temp: {}

trigger:
  branch:
    - NestJS-V2